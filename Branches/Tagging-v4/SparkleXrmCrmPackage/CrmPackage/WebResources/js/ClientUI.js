// ClientUI.js
(function($){
Type.registerNamespace('ClientUI.Common');ClientUI.Common.DataHelper=function(){}
ClientUI.Common.DataHelper.getWebResourceData=function(innerSeparator){var $0=window.location.search;if($0!=null&&!!$0){var $1=$0.substr(1).split('&');var $enum1=ss.IEnumerator.getEnumerator($1);while($enum1.moveNext()){var $2=$enum1.current;if($2.toLowerCase().startsWith('data=')){var $3=$2.replaceAll('+',' ').split('=');return ClientUI.Common.DataHelper.$0($3[1],innerSeparator);}}}return {};}
ClientUI.Common.DataHelper.$0=function($p0,$p1){var $0={};var $1=(decodeURIComponent(decodeURIComponent($p0))).split($p1);var $enum1=ss.IEnumerator.getEnumerator($1);while($enum1.moveNext()){var $2=$enum1.current;var $3=$2.split('=');$0[$3[0]]=$3[1];}return $0;}
ClientUI.Common.ListExtension=function(){}
ClientUI.Common.ListExtension.sortBy=function(field,reverse,primer){var $0=function($p1_0){
return (primer==null)?$p1_0[field]:primer($p1_0[field]);};return function($p1_0,$p1_1){
var $1_0=$0($p1_0),$1_1=$0($p1_1);return String.compare($1_0,$1_1)*((reverse)?-1:1);};}
ClientUI.Common.Security=function(){}
ClientUI.Common.Security.checkPrivileges=function(done){alert('YOU MUST UPDATE THE CHECK PRIVILEGES MANUALLY!');}
Type.registerNamespace('ClientUI.Tagging.Model');ClientUI.Tagging.Model.MultiTagModel=function(){}
ClientUI.Tagging.Model.MultiTagModel.prototype={tag:null,Id:null}
ClientUI.Tagging.Model.TagModel=function(){}
ClientUI.Tagging.Model.TagModel.prototype={id:null,name:null,synonyms:null,backColor:null,fontColor:null,borderColor:null,saveName:null,tagCount:null}
Type.registerNamespace('ClientUI.Model');ClientUI.Model.WebResourceSettings=function(){}
ClientUI.Model.WebResourceSettings.prototype={disableListSelection:false,resultsLimit:0,minChars:0,parents:null,excludeParents:null,allowParentSelection:false,existingTagsOnly:false,multitag:false}
Type.registerNamespace('ClientUI.Tagging.ViewModels');ClientUI.Tagging.ViewModels.TaggingViewModel=function(){this.settings=new ClientUI.Model.WebResourceSettings();this.message=ko.observable();this.shouldShowMessage=ko.observable(false);this.waitForSave=ko.observable();this.updateList=[];ClientUI.Tagging.ViewModels.TaggingViewModel.initializeBase(this);}
ClientUI.Tagging.ViewModels.TaggingViewModel.openTagRecord=function(tokenIds,tagName,entityName){tagName=unescape(tagName);var $0=Xrm.Page.context.getClientUrl();if(!$0.endsWith('/')){$0+='/';}var $1='location=no,menubar=no,status=yes,toolbar=no,resizable=yes';var $2;var $3=tokenIds.split(':');$2=$3[1];if($2==null){var $4="\r\n<fetch distinct='false' mapping='logical' output-format='xml-platform' version='1.0' top='1'>\r\n  <entity name='xrmc_tag'>\r\n    <attribute name='xrmc_name'/>\r\n    <attribute name='xrmc_parent'/>\r\n    <attribute name='xrmc_tagid'/>\r\n    <order descending='false' attribute='xrmc_name'/>\r\n    <filter type='and'>\r\n      <condition attribute='xrmc_name' value='{0}' operator='eq' />\r\n    </filter>\r\n  </entity>\r\n</fetch>";SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple(String.format($4,tagName),function($p1_0){
try{var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);var $1_1=$1_0.entities._internalArray;if($1_1.length>0){var $1_2=$1_1[0];$2=$1_2.id;var $1_3={};$1_3['entityName']='xrmc_tag';$1_3['entityId']=$2;Xrm.Navigation.openForm($1_3);}}catch($1_4){var $1_5=$1_4.message;}});}else{var $5={};$5['entityName']='xrmc_tag';$5['entityId']=$2;Xrm.Navigation.openForm($5);}}
ClientUI.Tagging.ViewModels.TaggingViewModel.prototype={tagList:null,allowedTagList:null,loader:'',retainFocus:false,updateItem:0,updateTotal:0,multiDelete:false,typeName:null,$1_0:null,init:function(done){if(Xrm.Page.data==null){Xrm.Page.data=window.parent.Xrm.Page.data;}if(this.allowedTagList!=null&&!this.waitForSave()){return;}if(!this.settings.multitag&&String.isNullOrEmpty(Xrm.Page.data.entity.getId())){this.showMessage(ResourceStrings.onCreate);this.hideLoader();this.waitForSave(true);this.waitForAutosave(done);return;}this.waitForSave(false);this.initTagging(ss.Delegate.create(this,function(){
if(Xrm.Page.data==null){if(!this.settings.multitag){this.hideLoader();done();return;}}if(this.isOffline()){this.showMessage(ResourceStrings.offline);done();}else{this.getTagConnectionCount(ss.Delegate.create(this,function($p2_0){
if($p2_0){this.showMessage(ResourceStrings.exceededLimit);this.hideLoader();done();}else{if(this.settings.multitag||!String.isNullOrEmpty(Xrm.Page.data.entity.getId())){if(!this.settings.multitag){$('#selectTagsToggle').show();}ClientUI.Common.Security.checkPrivileges(ss.Delegate.create(this,function($p3_0,$p3_1){
var $3_0=$p3_0==='Tag Writer';var $3_1=$p3_0==='Tag Associator';var $3_2=$p3_0==='Tag Reader';if($3_0&&!this.settings.existingTagsOnly){$(ClientUI.Tagging.ViewModels.TaggingViewModel.md).hide();this.receivedTagList('&times;',true,false,done);}else if($3_1||$3_0){$(ClientUI.Tagging.ViewModels.TaggingViewModel.md).hide();if(this.settings.multitag){$('.instructions').text('Enter text below to search for existing tags');}this.receivedTagList('&times;',false,false,done);}else if($3_2){this.settings.disableListSelection=true;if(this.settings.multitag){$('.instructions').text('');this.showMessage(ResourceStrings.multiTagNotAllowed);}else{$(ClientUI.Tagging.ViewModels.TaggingViewModel.md).hide();this.receivedTagList('',false,true,done);}}else{if(String.isNullOrEmpty($p3_1)){this.showMessage(ResourceStrings.notAuthorised);}else{this.showMessage($p3_1);}done();}}));}else{this.showMessage(ResourceStrings.onCreate);this.hideLoader();this.waitForSave(true);this.waitForAutosave(done);}}}));}}));},initTagCloud:function(){ClientUI.Common.Security.checkPrivileges(ss.Delegate.create(this,function($p1_0,$p1_1){
if($p1_0==='Tag Writer'||$p1_0==='Tag Associator'||$p1_0==='Tag Reader'){var $1_0="<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>"+"<entity name='xrmc_tag'>"+"<attribute name='xrmc_tagid' />"+"<attribute name='xrmc_name' />"+"<attribute name='createdon' />"+"<attribute name='xrmc_parent' />"+"<attribute name='xrmc_tagcount' />"+"<order attribute='xrmc_tagcount' descending='true' />"+"<filter type='and'>"+"<condition attribute='statecode' operator='eq' value='0' />"+"<condition attribute='xrmc_tagcount' operator='gt' value='0' />"+'</filter>'+'</entity>'+'</fetch>';var $1_1=encodeURIComponent($1_0);SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($1_0,ss.Delegate.create(this,function($p2_0){
try{var $2_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p2_0,SparkleXrm.Sdk.Entity);ClientUI.Tagging.ViewModels.TaggingViewModel.allTags=$2_0.entities._internalArray;this.parseParams(ss.Delegate.create(this,function($p3_0){
var $3_0=[];for(var $3_3=0;$3_3<ClientUI.Tagging.ViewModels.TaggingViewModel.allTags.length;$3_3++){if(this.tagAllowed(ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3_3])){var $3_4=new ClientUI.Tagging.Model.TagModel();$3_4.id=ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3_3].id;$3_4.name=ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3_3].getAttributeValueString('xrmc_name');$3_4.tagCount=ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3_3].getAttributeValueInt('xrmc_tagcount');$3_0.push($3_4);}}$3_0.sort(ClientUI.Common.ListExtension.sortBy('xrmc_tagcount',false,null));$3_0=$3_0.slice(0,29);var $3_1=[];for(var $3_5=0;$3_5<$3_0.length;$3_5++){var $3_6;if($3_5<$3_0.length-1){$3_6=', ';}else{$3_6='';}var $3_7=$3_0[$3_5];$3_1.push("<a href='javascript:ClientUI.Tagging.ViewModels.TaggingViewModel.openTagRecord(&quot;"+$3_7.id+'&quot;,&quot;'+this.oDataEscape(encodeURIComponent(this.htmlEncode($3_7.name)))+"&quot;,&quot;xrmc_tag&quot;);' rel='"+$3_7.tagCount+"'>"+$3_7.name+'</a>'+$3_6);}$('#xrmc-tagCloud').append($3_1.join(''));var $3_2={};$3_2.size={};$3_2.size.start=14;$3_2.size.end=22;$3_2.size.unit='pt';$3_2.color={};$3_2.color.start='#00188f';$3_2.color.end='#f60';$.fn.tagcloud.defaults=$3_2;$(function(){
($('#xrmc-tagCloud a')).tagcloud();});}));}catch($2_1){this.showMessage('Error loading tag cloud: '+$2_1.message);}}));}else{this.showMessage('Not Authorised');}}));},waitForAutosave:function(done){if(!String.isNullOrEmpty(Xrm.Page.data.entity.getId())){this.hideMessage();this.init(done);}else{window.setTimeout(ss.Delegate.create(this,function(){
this.waitForAutosave(done);}),100);}},showMessage:function(message){this.message(message);this.shouldShowMessage(true);},hideMessage:function(){this.message(null);this.shouldShowMessage(false);},initTagging:function(done){this.allowedTagList=[];var $0="<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>"+"<entity name='xrmc_tag'>"+"<attribute name='xrmc_tagid' />"+"<attribute name='xrmc_name' />"+"<attribute name='createdon' />"+"<attribute name='xrmc_parent' />"+"<attribute name='xrmc_tagcount' />"+"<attribute name='xrmc_synonyms' />"+"<attribute name='xrmc_backcolor' />"+"<attribute name='xrmc_fontcolor' />"+"<attribute name='xrmc_bordercolor' />"+"<order attribute='xrmc_tagcount' descending='true' />"+"<filter type='and'>"+"<condition attribute='statecode' operator='eq' value='0' />"+'</filter>'+'</entity>'+'</fetch>';SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($0,ss.Delegate.create(this,function($p1_0){
try{var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);ClientUI.Tagging.ViewModels.TaggingViewModel.allTags=$1_0.entities._internalArray;this.parseParams(ss.Delegate.create(this,function($p2_0){
if(this.settings.multitag){this.settings.resultsLimit=10;}for(var $2_0=0;$2_0<ClientUI.Tagging.ViewModels.TaggingViewModel.allTags.length;$2_0++){var $2_1=ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$2_0];if(this.tagAllowed($2_1)){var $2_2=new ClientUI.Tagging.Model.TagModel();$2_2.id=$2_1.id;$2_2.name=$2_1.getAttributeValueString('xrmc_name');$2_2.synonyms=[];var $2_3=$2_1.getAttributeValueString('xrmc_synonyms');if(!!$2_3){if($2_3.indexOf(',')>-1){var $2_4=$2_3.split(',');for(var $2_5=0;$2_5<$2_4.length;$2_5++){$2_2.synonyms.push($2_4[$2_5].trim());}}else{$2_2.synonyms.push($2_3.trim());}}$2_2.backColor=$2_1.getAttributeValueString('xrmc_backcolor');$2_2.fontColor=$2_1.getAttributeValueString('xrmc_fontcolor');$2_2.borderColor=$2_1.getAttributeValueString('xrmc_bordercolor');this.allowedTagList.push($2_2);if(!this.settings.multitag&&!this.settings.disableListSelection){var $2_6={};$2_6.taglabel=$2_2.name;$2_6.tagname=$2_2.name;$2_6.tagcheck=$2_2.name;$2_6.tagvalue=$2_2.name;this.tagList.add($2_6);}}}done();}));}catch($1_1){this.showMessage(ResourceStrings.notAuthorised);this.hideLoader();}}));},getTagById:function(id){for(var $0=0;$0<ClientUI.Tagging.ViewModels.TaggingViewModel.allTags.length;$0++){if(ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$0].id===id){return ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$0];}}return SparkleXrm.Sdk.OrganizationServiceProxy.retrieve('xrmc_tag',id,['xrmc_name','xrmc_backcolor','xrmc_fontcolor','xrmc_bordercolor']);},getTagByName:function(tagName){for(var $3=0;$3<ClientUI.Tagging.ViewModels.TaggingViewModel.allTags.length;$3++){if(ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3].getAttributeValueString('xrmc_name')===tagName){return Promise.resolve(ClientUI.Tagging.ViewModels.TaggingViewModel.allTags[$3]);}}var $0="<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>"+"  <entity name='xrmc_tag'>"+"    <attribute name='xrmc_tagid' />"+"    <attribute name='xrmc_name' />"+"    <attribute name='xrmc_parent' />"+"    <filter type='and'>"+"      <condition attribute='xrmc_name' operator='eq' value='"+tagName+"' />"+'    </filter>'+'  </entity>'+'</fetch>';var $1=SparkleXrm.Sdk.OrganizationServiceProxy.retrieveMultiple($0);var $2=$1.entities._internalArray;if($2.length>0){return Promise.resolve($2[0]);}return Promise.resolve(null);},displayLoader:function(){$(ClientUI.Tagging.ViewModels.TaggingViewModel.td).blur();$('#loadingfull').show();return $.Deferred();},hideLoader:function(){$('#loadingfull').hide();},isOffline:function(){if(Xrm.Page.context.client!=null&&Xrm.Page.context.client.getClient()==='Outlook'&&Xrm.Page.context.client.getClientState()==='Offline'){return true;}return false;},getTagConnectionCount:function(done){var $0="<fetch  mapping='logical' aggregate='true' >"+"<entity name='xrmc_taggingconfiguration'>"+"<attribute name='xrmc_taggingconfigurationid' aggregate='count' alias='count' />"+"<filter type='and'>"+"<condition attribute='xrmc_licensekeystatus' operator='eq' value='922680000' />"+'</filter>'+'</entity>'+'</fetch>';SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($0,ss.Delegate.create(this,function($p1_0){
try{var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);var $1_1=$1_0.entities._internalArray;if($1_1.length>0){var $1_2=$1_1[0];var $1_3=this.getAggregateValueAsInt($1_2,'count');if($1_3!==1){$0="<fetch mapping='logical' aggregate='true' >"+"<entity name='connection' >"+"<attribute name='connectionid' aggregate='count' alias='count' />"+"<filter type='and' >"+"<condition attribute='record1roleid' operator='eq' uiname='Tag' uitype='connectionrole' value='{A6594384-3BD4-E211-8A32-3C4A92DBDC51}' />"+'</filter>'+'</entity>'+'</fetch>';try{SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($0,ss.Delegate.create(this,function($p2_0){
var $2_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p2_0,SparkleXrm.Sdk.Entity);var $2_1=$2_0.entities._internalArray;var $2_2=$2_1[0];if($2_2.logicalName!=='connection'){return;}var $2_3=this.getAggregateValueAsInt($2_2,'count');if($2_3>25){done(true);return;}else{done(false);return;}}));}catch($1_4){this.showMessage('Error occurred validating tags: '+$1_4.message);return;}}else{done(false);return;}}}catch($1_5){this.showMessage('Error occurred validating tags: '+$1_5.message);return;}}));},getAggregateValueAsInt:function(e,a){var $0=e.formattedValues[a];if($0!=null){return parseInt($0,10);}var $1=e.getAttributeValueOptionSet(a);if($1!=null&&$1.value!=null){return $1.value;}return e.getAttributeValueInt(a);},receivedTagList:function(deleteText,freetagging,disable,done){this.getPrepopulateTags(ss.Delegate.create(this,this.receivedPrePopulate),deleteText,freetagging,disable,done);},getPrepopulateTags:function(receivedPrePopulateCallback,deleteText,freetagging,disable,done){if(this.settings.multitag){receivedPrePopulateCallback([],deleteText,freetagging,disable,done);return;}var $0='';$0="\r\n        <fetch top='50' >\r\n          <entity name='connection' >\r\n            <attribute name='connectionid' />\r\n            <attribute name='record1id' />\r\n            <filter type='and' >\r\n              <condition attribute='record1roleid' operator='eq' value='A6594384-3BD4-E211-8A32-3C4A92DBDC51' />\r\n              <condition attribute='record2id' operator='eq' value='"+Xrm.Page.data.entity.getId()+"' />\r\n            </filter>\r\n          </entity>\r\n        </fetch>";SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($0,ss.Delegate.create(this,function($p1_0){
var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);var $1_1=$1_0.entities._internalArray;var $1_2=[];for(var $1_3=0;$1_3<$1_1.length;$1_3++){var $1_4=$1_1[$1_3];var $1_5=this.getTagById($1_4.getAttributeValueEntityReference('record1id').id.toString());if(this.tagAllowed($1_5)){var $1_6=new ClientUI.Tagging.Model.TagModel();$1_6.id=$1_4.id+':'+$1_5.id;$1_6.name=$1_5.getAttributeValueString('xrmc_name');$1_6.backColor=$1_5.getAttributeValueString('xrmc_backcolor');$1_6.fontColor=$1_5.getAttributeValueString('xrmc_fontcolor');$1_6.borderColor=$1_5.getAttributeValueString('xrmc_bordercolor');$1_2.push($1_6);}}receivedPrePopulateCallback($1_2,deleteText,freetagging,disable,done);}));},receivedPrePopulate:function(prepopulateList,deleteText,freetagging,disable,done){prepopulateList.sort(ClientUI.Common.ListExtension.sortBy('name',false,function($p1_0){
if(!String.isNullOrEmpty($p1_0)){return $p1_0.toUpperCase();}return '';}));ClientUI.Tagging.ViewModels.TaggingViewModel.runningList=prepopulateList;for(var $2=0;$2<ClientUI.Tagging.ViewModels.TaggingViewModel.runningList.length;$2++){$("input[value='"+this.prettyTag(ClientUI.Tagging.ViewModels.TaggingViewModel.runningList[$2].name)+"']").attr('checked','true');}var $0={};$0.hintText='Search for existing tag...';$0.noResultsText='No tags found';$0.searchingText='Searching...';$0.preventDuplicates=true;$0.deleteText=deleteText;$0.allowFreeTagging=freetagging;$0.allowTabOut=true;$0.tokenValue='name';$0.disabled=disable;$0.resultsLimit=this.settings.resultsLimit;$0.minChars=this.settings.minChars;$0.tokenDelimiter='|';$0.prePopulate=prepopulateList;$0.tokenFormatter=ss.Delegate.create(this,function($p1_0){
if($p1_0!=null){if(!String.isNullOrEmpty($p1_0.backColor)){return "<li style='background-color:"+$p1_0.backColor+'; color:'+$p1_0.fontColor+'; border-color:'+$p1_0.borderColor+"'><p ondblclick='javascript:ClientUI.Tagging.ViewModels.TaggingViewModel.openTagRecord(&quot;"+$p1_0.id+'&quot;,&quot;'+this.oDataEscape(encodeURIComponent(this.htmlEncode($p1_0.name)))+"&quot;,&quot;xrmc_tag&quot;);'>"+$p1_0.name+'</p></li>';}else{return "<li><p ondblclick='javascript:ClientUI.Tagging.ViewModels.TaggingViewModel.openTagRecord(&quot;"+$p1_0.id+'&quot;,&quot;'+this.oDataEscape(encodeURIComponent(this.htmlEncode($p1_0.name)))+"&quot;,&quot;xrmc_tag&quot;);'>"+$p1_0.name+'</p></li>';}}return '<li><p>...</p></li>';});$0.onAdd=ss.Delegate.create(this,function($p1_0){
var $1_0=this.prettyTag($p1_0.name);$p1_0.saveName=$1_0;$p1_0.name=this.htmlEncode($1_0);if(this.settings.multitag){ClientUI.Tagging.ViewModels.TaggingViewModel.newTags.push($p1_0.name);return;}ClientUI.Tagging.ViewModels.TaggingViewModel.runningList.push($p1_0);if($("input[value='"+$p1_0.saveName+"']").length>0){$("input[value='"+$p1_0.saveName+"']").attr('checked','true');}else{}var $1_1=this.getTimerValue();this.displayLoader();var $1_2=$p1_0.name;var $1_3=$p1_0.saveName;window.setTimeout(ss.Delegate.create(this,function(){
var $2_0=Xrm.Page.data.entity.getEntityName();var $2_1=Xrm.Page.data.entity.getId();this.createTag($1_2,$1_3,$2_1,'',$2_0,$1_1,null);}),0);});$0.onDelete=ss.Delegate.create(this,function($p1_0){
if(this.settings.multitag){return;}ClientUI.Tagging.ViewModels.TaggingViewModel.runningList=ClientUI.Tagging.ViewModels.TaggingViewModel.runningList.filter(function($p2_0){
return $p2_0.name!==$p1_0.name;});this.displayLoader();try{this.deleteTagConnection($p1_0.id);$("input[value='"+this.prettyTag($p1_0.name)+"']").attr('checked','false').removeAttr('checked');}catch($1_0){$(ClientUI.Tagging.ViewModels.TaggingViewModel.td).data('tokenInputObject').add(item, nocallback = true);}this.hideLoader();});var $1=$(ClientUI.Tagging.ViewModels.TaggingViewModel.td);$1.tokenInput(this.allowedTagList,$0);this.hideLoader();done();},tagAllowed:function(tag){if(this.settings.parents!=null&&this.settings.parents.length>0){if(this.settings.allowParentSelection){for(var $0=0;$0<this.settings.parents.length;$0++){if(this.settings.parents[$0].name===tag.getAttributeValueString('xrmc_name')){return true;}}}for(var $1=0;$1<this.settings.parents.length;$1++){if(tag.getAttributeValueEntityReference('xrmc_Parent')!=null){if(this.settings.parents[$1].name===tag.getAttributeValueEntityReference('xrmc_Parent').name){return true;}var $2=null;this.getTagByName(tag.getAttributeValueEntityReference('xrmc_Parent').name).then(function($p1_0){
$2=$p1_0;return Promise.resolve($p1_0);});if($2!=null&&this.tagAllowed($2)){return true;}}}return false;}if(this.settings.excludeParents!=null&&this.settings.excludeParents.length>0){for(var $3=0;$3<this.settings.excludeParents.length;$3++){if(this.settings.excludeParents[$3].name===tag.getAttributeValueString('xrmc_name')){return false;}}for(var $4=0;$4<this.settings.excludeParents.length;$4++){if(tag.getAttributeValueEntityReference('xrmc_Parent')!=null){if(this.settings.excludeParents[$4].name===tag.getAttributeValueEntityReference('xrmc_Parent').name){return false;}var $5=null;this.getTagByName(tag.getAttributeValueEntityReference('xrmc_Parent').name).then(function($p1_0){
$5=$p1_0;return Promise.resolve($p1_0);});if($5!=null&&!this.tagAllowed($5)){return false;}}}}return true;},createTag:function(tagName,saveName,recordId,recordName,entityName,startTime,done){this.getTagConnectionCount(ss.Delegate.create(this,function($p1_0){
if($p1_0){this.showMessage(ResourceStrings.exceededLimit);this.hideLoader();if(done!=null){done();}return;}this.getTagByName(tagName).then(ss.Delegate.create(this,function($p2_0){
if($p2_0!=null){if(!this.tagAllowed($p2_0)){this.deleteTag(tagName);if(done!=null){done();}return Promise.resolve(null);}this.createTagConnection(recordId,recordName,entityName,$p2_0.getAttributeValue('xrmc_tagid').toString(),tagName,startTime,done);}else{$p2_0=new SparkleXrm.Sdk.Entity('xrmc_tag');$p2_0.setAttributeValue('xrmc_name',saveName);if(this.settings.parents!=null&&this.settings.parents.length>0){$p2_0.setAttributeValue('xrmc_Parent',new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid(this.settings.parents[0].id),'xrmc_tag',this.settings.parents[0].name));}SparkleXrm.Sdk.OrganizationServiceProxy.beginCreate($p2_0,ss.Delegate.create(this,function($p3_0){
var $3_0=SparkleXrm.Sdk.OrganizationServiceProxy.endCreate($p3_0);this.createTagConnection(recordId,recordName,entityName,$3_0.toString(),tagName,startTime,done);if(!this.settings.multitag&&!this.settings.disableListSelection){var $3_1={};$3_1.taglabel=tagName;$3_1.tagname=tagName;$3_1.tagcheck=tagName;$3_1.tagvalue=tagName;this.tagList.add($3_1);this.tagList.sort('tagname',{ order: 'asc' });var $3_2=$("input[value='"+tagName+"']");$3_2.attr('checked','true');}}));}return Promise.resolve($p2_0);}));}));},createTagConnection:function(recordId,recordName,entityName,tagId,tagName,startTime,done){if(this.connectionExists(recordId,entityName,tagId)){if(this.settings.multitag){if(done!=null){done();}return;}if(this.getTimerValue()-startTime<800){window.setTimeout(ss.Delegate.create(this,this.hideLoader),800-(this.getTimerValue()-startTime));}else{this.hideLoader();}if(done!=null){done();}return;}this.retainFocus=true;var $0=new SparkleXrm.Sdk.Entity('connection');$0.setAttributeValue('record2id',new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid(recordId),entityName,recordName));$0.setAttributeValue('record1id',new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid(tagId),'xrmc_tag',tagName));$0.setAttributeValue('record1roleid',new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid('A6594384-3BD4-E211-8A32-3C4A92DBDC51'),'connectionrole','Tag'));if(this.settings.multitag){SparkleXrm.Sdk.OrganizationServiceProxy.beginCreate($0,function($p1_0){
SparkleXrm.Sdk.OrganizationServiceProxy.endCreate($p1_0);if(done!=null){done();}});}else{SparkleXrm.Sdk.OrganizationServiceProxy.beginCreate($0,ss.Delegate.create(this,function($p1_0){
var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endCreate($p1_0);var $1_1=$1_0+':'+tagId;this.updateTagId(tagName,$1_1);if(this.getTimerValue()-startTime<800){window.setTimeout(ss.Delegate.create(this,this.hideLoader),800-(this.getTimerValue()-startTime));}else{this.hideLoader();}if(done!=null){done();}}));}},updateTagId:function(tagName,newTagIds){var $0=$(ClientUI.Tagging.ViewModels.TaggingViewModel.td).data('tokenInputObject');var $1=$0.getTokens();var $2=$1.length;for(var $3=0;$3<$2;$3++){if(($1[$3].name||'').toLowerCase()===(tagName||'').toLowerCase()){$1[$3].id=newTagIds;break;}}},connectionExists:function(recordId,entityName,tagId){var $0="<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>"+"<entity name='connection'>"+"<attribute name='record2id' />"+"<attribute name='record2roleid' />"+"<attribute name='connectionid' />"+"<order attribute='record2id' descending='false' />"+"<filter type='and'>"+"<condition attribute='record2id' operator='eq' uitype='"+entityName+"' value='"+recordId+"' />"+"<condition attribute='record1id' operator='eq' uitype='xrmc_tag' value='"+tagId+"' />"+'</filter>'+'</entity>'+'</fetch>';var $1=SparkleXrm.Sdk.OrganizationServiceProxy.retrieveMultiple($0);var $2=$1.entities._internalArray;if($2.length>0){return $2[0].id;}return false;},deleteTag:function(tagName){var $0=$(ClientUI.Tagging.ViewModels.TaggingViewModel.td).data('tokenInputObject');var $1=$0.getTokens();var $2=$1.length;for(var $3=0;$3<$2;$3++){if(($1[$3].name||'').toLowerCase()===(tagName||'').toLowerCase()){$0.remove($1[$3]);break;}}},deleteTagConnection:function(connectionAndTagId){if(!String.isNullOrEmpty(connectionAndTagId)){var $0=connectionAndTagId.split(':');var $1=$0[0];SparkleXrm.Sdk.OrganizationServiceProxy.beginDelete('connection',new SparkleXrm.Sdk.Guid($1),function($p1_0){
SparkleXrm.Sdk.OrganizationServiceProxy.endDelete($p1_0);});}},prettyTag:function(rawtag){return $('<div/>').html(rawtag).text();},htmlEncode:function(value){return $('<div/>').text(value).html();},oDataEscape:function(str){return str.replaceAll("'",'%27%27');},getTimerValue:function(){return  (performance.now !== undefined ? performance.now() : new Date().getTime());},parseParams:function(callback){var $0=[];this.settings.resultsLimit=5;this.settings.minChars=2;var $1=ClientUI.Common.DataHelper.getWebResourceData('|');if($1['resultslimit']!=null){this.settings.resultsLimit=parseInt($1['resultslimit'],10);}if($1['minsearchchars']!=null){this.settings.minChars=parseInt($1['minsearchchars'],10);}if($1['parent']!=null){this.settings.parents=[];var $2=$1['parent'].split(',');for(var $3=0;$3<$2.length;$3++){$0.push(this.getTagByName($2[$3]).then(ss.Delegate.create(this,function($p1_0){
if($p1_0!=null){var $1_0=new ClientUI.Tagging.Model.TagModel();$1_0.id=$p1_0.id;$1_0.name=$p1_0.getAttributeValueString('xrmc_name');this.settings.parents.push($1_0);return Promise.resolve($1_0);}return Promise.resolve(null);})));}}if($1['excludeparent']!=null){this.settings.excludeParents=[];var $4=$1['excludeparent'].split(',');for(var $5=0;$5<$4.length;$5++){$0.push(this.getTagByName($4[$5]).then(ss.Delegate.create(this,function($p1_0){
if($p1_0!=null){var $1_0=new ClientUI.Tagging.Model.TagModel();$1_0.id=$p1_0.id;$1_0.name=$p1_0.getAttributeValueString('xrmc_name');this.settings.excludeParents.push($1_0);return Promise.resolve($1_0);}return Promise.resolve(null);})));}}if($1['allowparentselection']!=null){this.settings.allowParentSelection=this.$1_1($1['allowparentselection']);}if($1['existingtagsonly']!=null){this.settings.existingTagsOnly=this.$1_1($1['existingtagsonly']);}if($1['disablelistselection']!=null){this.settings.disableListSelection=this.$1_1($1['disablelistselection']);}Promise.all($0).then(callback);},$1_1:function($p0){var $0=$p0.toLowerCase();if($0==='yes'||$0==='true'||$0==='1'){return true;}return false;},addTag:function(tag,loader){this.loader=loader;var $0=$.grep(this.allowedTagList,ss.Delegate.create(this,function($p1_0,$p1_1){
return this.prettyTag(($p1_0).name)===this.prettyTag(tag);}));if($0.length>0){var $1=$(ClientUI.Tagging.ViewModels.TaggingViewModel.td);$1.tokenInput('add',$0[0]);}},removeTag:function(tag,loader){this.loader=loader;$("#xrmc-tags").tokenInput("remove", { name:tag });},save:function(deleteFlag){$('#processingBlanket').show();$('#progressbar').width($(window).width()-30);$('#progressbar').show();this.updateList=[];this.updateItem=0;for(var $0=0;$0<ClientUI.Tagging.ViewModels.TaggingViewModel.newTags.length;$0++){for(var $1=0;$1<ClientUI.Tagging.ViewModels.TaggingViewModel.selectedIds.length;$1++){var $2=new ClientUI.Tagging.Model.MultiTagModel();$2.tag=ClientUI.Tagging.ViewModels.TaggingViewModel.newTags[$0];$2.Id=ClientUI.Tagging.ViewModels.TaggingViewModel.selectedIds[$1];this.updateList.push($2);}}this.updateTotal=this.updateList.length;this.multiDelete=deleteFlag;window.setTimeout(ss.Delegate.create(this,this.recursiveSave),1);},recursiveSave:function(){var $0=this.updateItem;var $1=this.updateTotal;var $2=this.updateList[$0];if($2==null){window.open('','_parent','').close();return;}if(this.multiDelete){this.deleteTagExt($2.Id,this.typeName,$2.tag,ss.Delegate.create(this,function(){
var $1_0=$('#progressbar');var $1_1={};$1_1.value=$0*100/$1;$1_0.progressbar($1_1);if($0<$1){this.updateItem=$0+1;window.setTimeout(ss.Delegate.create(this,this.recursiveSave),1);}else{window.open('','_parent','').close();}}));}else{this.createTag($2.tag,$2.tag,$2.Id,'',this.typeName,this.getTimerValue(),ss.Delegate.create(this,function(){
var $1_0=$('#progressbar');var $1_1={};$1_1.value=$0*100/$1;$1_0.progressbar($1_1);if($0<$1){this.updateItem=$0+1;window.setTimeout(ss.Delegate.create(this,this.recursiveSave),1);}else{window.open('','_parent','').close();}}));}},deleteTagExt:function(entityId,entityName,tagName,done){this.getTagByName(tagName).then(ss.Delegate.create(this,function($p1_0){
var $1_0=this.connectionExists(entityId,entityName,$p1_0.id);if($1_0!=null){SparkleXrm.Sdk.OrganizationServiceProxy.beginDelete('connection',new SparkleXrm.Sdk.Guid($1_0),function($p2_0){
SparkleXrm.Sdk.OrganizationServiceProxy.endDelete($p2_0);if(done!=null){done();}});}else{if(done!=null){done();}}return Promise.resolve($p1_0);}));}}
Type.registerNamespace('ClientUI.Tagging.Views');ClientUI.Tagging.Views.TagCloudView=function(){ClientUI.Tagging.Views.TagCloudView.initializeBase(this);}
ClientUI.Tagging.Views.TagCloudView.init=function(){if (typeof Build !== 'undefined' && Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE)) { WebView.setWebContentsDebuggingEnabled(true); }};SparkleXrm.Xrm.PageEx.majorVersion=2013;$(function(){
ClientUI.Tagging.Views.TagCloudView.vm=new ClientUI.Tagging.ViewModels.TaggingViewModel();SparkleXrm.ViewBase.sparkleXrmTemplatePath='sparkle.form.templates.htm';SparkleXrm.ViewBase.registerViewModel(ClientUI.Tagging.Views.TagCloudView.vm);ClientUI.Tagging.Views.TagCloudView.vm.initTagCloud();});}
ClientUI.Tagging.Views.MultiTagView=function(){ClientUI.Tagging.Views.MultiTagView.initializeBase(this);}
ClientUI.Tagging.Views.MultiTagView.initMultiTag=function(){if (typeof Build !== 'undefined' && Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE)) { WebView.setWebContentsDebuggingEnabled(true); }};SparkleXrm.Xrm.PageEx.majorVersion=2013;var $0=ClientUI.Common.DataHelper.getWebResourceData('|');var $1=$0['t'];ClientUI.Tagging.ViewModels.TaggingViewModel.selectedIds=$0['e'].split(',');ClientUI.Tagging.Views.MultiTagView.vm=new ClientUI.Tagging.ViewModels.TaggingViewModel();SparkleXrm.ViewBase.sparkleXrmTemplatePath='sparkle.form.templates.htm';SparkleXrm.ViewBase.registerViewModel(ClientUI.Tagging.Views.MultiTagView.vm);ClientUI.Tagging.Views.MultiTagView.vm.typeName=$1;ClientUI.Tagging.Views.MultiTagView.vm.settings.multitag=true;ClientUI.Tagging.Views.MultiTagView.vm.retainFocus=true;ClientUI.Tagging.Views.MultiTagView.vm.init(ClientUI.Tagging.Views.MultiTagView.initComplete);}
ClientUI.Tagging.Views.MultiTagView.saveAll=function(){$('#saveTags').attr('disabled', true);$('#deleteTags').attr('disabled', true);ClientUI.Tagging.Views.MultiTagView.vm.save(false);}
ClientUI.Tagging.Views.MultiTagView.deleteAll=function(){$('#saveTags').attr('disabled', true);$('#deleteTags').attr('disabled', true);ClientUI.Tagging.Views.MultiTagView.vm.save(true);}
ClientUI.Tagging.Views.MultiTagView.initComplete=function(){$('#progresscurtain').hide();$('.save-button').on('click',function($p1_0){
ClientUI.Tagging.Views.MultiTagView.saveAll();});$('.delete-button').on('click',function($p1_0){
ClientUI.Tagging.Views.MultiTagView.deleteAll();});}
ClientUI.Tagging.Views.TaggingView=function(){ClientUI.Tagging.Views.TaggingView.initializeBase(this);}
ClientUI.Tagging.Views.TaggingView.init=function(){if (typeof Build !== 'undefined' && Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE)) { WebView.setWebContentsDebuggingEnabled(true); }};SparkleXrm.Xrm.PageEx.majorVersion=2013;$(window).resize(function($p1_0){
ClientUI.Tagging.Views.TaggingView.setHeights(null);});$(function(){
ClientUI.Tagging.Views.TaggingView.vm=new ClientUI.Tagging.ViewModels.TaggingViewModel();SparkleXrm.ViewBase.sparkleXrmTemplatePath='sparkle.form.templates.htm';SparkleXrm.ViewBase.registerViewModel(ClientUI.Tagging.Views.TaggingView.vm);ClientUI.Tagging.Views.TaggingView.vm.tagList=new List('selectTags',{ valueNames: ['tagname', 'taglabel', {name: 'taglabel', attr: 'for'}, {name: 'tagcheck', attr: 'id'}, {name: 'tagvalue', attr: 'value'} ], item: '<li><p class="tagname" style="display:none;"></p><input class="tagcheck tagvalue" id="" value="" type="checkbox" style="cursor: pointer;"><label  class="taglabel" for=""></label></li>' });ClientUI.Tagging.Views.TaggingView.vm.init(ClientUI.Tagging.Views.TaggingView.initComplete);});}
ClientUI.Tagging.Views.TaggingView.initComplete=function(){$('#xrmc-tags').hide();$('#selectTagsToggle').hide();$('#selectTagsToggle').mousedown(function(){
document.activeElement.blur();$('#taggingcontent').hide();$('#selectTags').show();ClientUI.Tagging.Views.TaggingView.setHeights(ClientUI.Tagging.Views.TaggingView.visibleListHeight());});$('#selectTagsHide').click(function(){
$('#selectTags').hide();$('#taggingcontent').show();$('#searchTags').val('');ClientUI.Tagging.Views.TaggingView.setHeights(0);ClientUI.Tagging.Views.TaggingView.vm.tagList.search();document.activeElement.blur();});ClientUI.Tagging.Views.TaggingView.vm.tagList.sort('tagname',{ order: 'asc' });ClientUI.Tagging.Views.TaggingView.setHeights(null);if(!ClientUI.Tagging.Views.TaggingView.vm.settings.disableListSelection){$('#token-input-xrmc-tags').on('focus',function($p1_0){
$('#selectTagsToggle').show();});$('#token-input-xrmc-tags').on('blur',function($p1_0){
$('#selectTagsToggle').hide();});$('#token-input-xrmc-tags').on('keypress',function($p1_0){
$('#selectTagsToggle').hide();});}$('#saveTags').click(function($p1_0){
$('#searchTags').val('');ClientUI.Tagging.Views.TaggingView.vm.tagList.search();var $1_0=[];$('#selectTags [type=checkbox]:checked').each(function($p2_0,$p2_1){
var $2_0=new ClientUI.Tagging.Model.TagModel();$2_0.name=$(this).val();$1_0.push($2_0);});var $1_1=$1_0.filter(ClientUI.Tagging.Views.TaggingView.comparer(ClientUI.Tagging.ViewModels.TaggingViewModel.runningList));for(var $1_3=0;$1_3<$1_1.length;$1_3++){ClientUI.Tagging.Views.TaggingView.vm.addTag($1_1[$1_3].name,'fullloader');}var $1_2=ClientUI.Tagging.ViewModels.TaggingViewModel.runningList.filter(ClientUI.Tagging.Views.TaggingView.comparer($1_0));for(var $1_4=0;$1_4<$1_2.length;$1_4++){ClientUI.Tagging.Views.TaggingView.vm.removeTag($1_2[$1_4].name,'fullloader');}$('#selectTags').hide();$('#taggingcontent').show();document.activeElement.blur();ClientUI.Tagging.Views.TaggingView.setHeights(0);});$('.sort').click(function($p1_0){
if(ClientUI.Tagging.Views.TaggingView.sortA===1){$(this).text('Sort \u2191');ClientUI.Tagging.Views.TaggingView.sortA=0;}else{$(this).text('Sort \u2193');ClientUI.Tagging.Views.TaggingView.sortA=1;}});}
ClientUI.Tagging.Views.TaggingView.comparer=function(otherArray){return function($p1_0){
return !otherArray.filter(function($p2_0){
return ClientUI.Tagging.Views.TaggingView.vm.prettyTag($p2_0.name)===ClientUI.Tagging.Views.TaggingView.vm.prettyTag($p1_0.name);}).length;};}
ClientUI.Tagging.Views.TaggingView.compareItems=function(current,otherArray){return !otherArray.filter(function($p1_0){
return ClientUI.Tagging.Views.TaggingView.vm.prettyTag($p1_0.name)===ClientUI.Tagging.Views.TaggingView.vm.prettyTag(current.name);}).length;}
ClientUI.Tagging.Views.TaggingView.visibleListHeight=function(){var $0=/*@cc_on!@*/false || !!document.documentMode;var $1=!isIE && !!window.StyleMedia;if($1){return document.body.scrollHeight;}return $(document).height();}
ClientUI.Tagging.Views.TaggingView.setHeights=function(h){var $0=0;var $1=typeof InstallTrigger !== 'undefined';if(h!=null){$0=h;}$('#selectTags').height($0);$('#selectTagContent').height($0);if($1){$('.list').height($('#selectTags').height()-62);}else{$('.list').height($('#selectTags').height()-59);}}
Type.registerNamespace('ClientUI');ResourceStrings=function(){}
ClientUI.Common.DataHelper.registerClass('ClientUI.Common.DataHelper');ClientUI.Common.ListExtension.registerClass('ClientUI.Common.ListExtension');ClientUI.Common.Security.registerClass('ClientUI.Common.Security');ClientUI.Tagging.Model.MultiTagModel.registerClass('ClientUI.Tagging.Model.MultiTagModel');ClientUI.Tagging.Model.TagModel.registerClass('ClientUI.Tagging.Model.TagModel');ClientUI.Model.WebResourceSettings.registerClass('ClientUI.Model.WebResourceSettings');ClientUI.Tagging.ViewModels.TaggingViewModel.registerClass('ClientUI.Tagging.ViewModels.TaggingViewModel',SparkleXrm.ViewModelBase);ClientUI.Tagging.Views.TagCloudView.registerClass('ClientUI.Tagging.Views.TagCloudView',SparkleXrm.ViewBase);ClientUI.Tagging.Views.MultiTagView.registerClass('ClientUI.Tagging.Views.MultiTagView',SparkleXrm.ViewBase);ClientUI.Tagging.Views.TaggingView.registerClass('ClientUI.Tagging.Views.TaggingView',SparkleXrm.ViewBase);ResourceStrings.registerClass('ResourceStrings');ClientUI.Tagging.ViewModels.TaggingViewModel.td='#xrmc-tags';ClientUI.Tagging.ViewModels.TaggingViewModel.md='#tagMessage';ClientUI.Tagging.ViewModels.TaggingViewModel.allTags=[];ClientUI.Tagging.ViewModels.TaggingViewModel.newTags=[];ClientUI.Tagging.ViewModels.TaggingViewModel.runningList=[];ClientUI.Tagging.ViewModels.TaggingViewModel.selectedIds=null;ClientUI.Tagging.Views.TagCloudView.vm=null;ClientUI.Tagging.Views.MultiTagView.vm=null;ClientUI.Tagging.Views.TaggingView.vm=null;ClientUI.Tagging.Views.TaggingView.sortA=0;ResourceStrings.notAuthorised="<span></span><div id='notAuthorised'>You do not have the correct permissions to use Tagging. Please contact your system administrator.</div>";ResourceStrings.onCreate="<span></span><div id='onCreate'>Tagging is only available once a record has been saved.</div>";ResourceStrings.exceededLimit="<span></span><div id='exceededLimit'>Your system has exceeded the Tag connection limit. Please contact xRM Consultancy (<a href='mailto:sales@xrmconsultancy.com'>sales@xrmconsultancy.com</a>) to purchase a license key.</div>";ResourceStrings.offline="<span></span><div id='onCreate'>Tagging is not available when offline.</div>";ResourceStrings.multiTagNotAllowed="<span></span><div id='notAuthorised'>Unfortunately you are not allowed to create or associate tags. Please contact your system administrator.</div>";})(window.xrmjQuery);